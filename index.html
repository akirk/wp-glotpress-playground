<!DOCTYPE html>
<html>
	<head>
		<title>WordPress Playground</title>
	</head>
	<body>
		<iframe id="wp" style="width: 1200px; height: 800px"></iframe>
		<script type="importmap">
			{
				"imports": {
					"@wp-playground/client": "https://unpkg.com/@wp-playground/client/index.js"
				}
			}
		</script>
		<script type="module">
			import { connectPlayground, login, installPluginsFromDirectory } from '@wp-playground/client';
			let response;
			const client = await connectPlayground(
				document.getElementById('wp'),
				{ loadRemote: 'https://playground.wordpress.net/remote.html' }
			);
			await client.isReady();
			await login(client, 'admin', 'password');
			await client.mkdirTree('/wordpress/wp-content/languages/plugins');

			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp/dev/de/default/export-translations?format=po' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/de_DE.po', new Uint8Array(response) ) );
			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp/dev/de/default/export-translations?format=mo' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/de_DE.mo', new Uint8Array(response) ) );
			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp/dev/admin/de/default/export-translations?format=po' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/admin-de_DE.po', new Uint8Array(response) ) );
			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp/dev/admin/de/default/export-translations?format=mo' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/admin-de_DE.mo', new Uint8Array(response) ) );
			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp-plugins/glotpress/dev/de/default/export-translations?format=po' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/plugins/glotpress-de_DE.po', new Uint8Array(response) ) );
			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp-plugins/glotpress/dev/de/default/export-translations?format=mo' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/plugins/glotpress-de_DE.mo', new Uint8Array(response) ) );
			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp-plugins/friends/dev/de/default/export-translations?format=po' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/plugins/friends-de_DE.po', new Uint8Array(response) ) );
			await fetch( '/translate-proxy?url=' + escape( 'https://translate.wordpress.org/projects/wp-plugins/friends/dev/de/default/export-translations?format=mo' ) )
			  .then(response => response.arrayBuffer() )
			  .then(response => client.writeFile( '/wordpress/wp-content/languages/plugins/friends-de_DE.mo', new Uint8Array(response) ) );
			response = await client.run({
			                code: `<?php
include 'wordpress/wp-load.php';
update_option('WPLANG', 'de_DE');
update_option('permalink_structure','/%year%/%monthnum%/%day%/%postname%/');
update_option('gp_enable_local_translation', 1);
update_option('gp_enable_inline_translation', 1);
file_put_contents('/wordpress/wp-content/mu-plugins/gp-sqlite.php',<<<'ENDP'
<?php
add_filter('query', function( $query ) {
	return str_replace( ' BINARY ', ' ', $query);
});
ENDP
);
readfile('/wordpress/wp-content/mu-plugins/gp-sqlite.php');
					            `});
			console.log(response.text);
			await installPluginsFromDirectory( client, ['glotpress-local','friends'] );
// 			await client.goTo('/wp-admin/plugins.php');
// 			console.log(response.text);
			await client.goTo('/wp-admin/admin.php?page=local-glotpress');
		</script>
	</body>
</html>
